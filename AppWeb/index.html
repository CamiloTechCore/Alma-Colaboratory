<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Operativo</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        /* Variables CSS */
        :root {
            --primary-color: #007bff;
            --primary-dark: #0056b3;
            --secondary-color: #6c757d;
            --secondary-dark: #5a6268;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --border-color: #ced4da;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        /* Estilos Generales */
        body {
            font-family: var(--font-family);
            background-color: #f0f2f5;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }

        /* Contenedor de Login */
        #loginContainer {
            background: #fff;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 4px 12px var(--shadow-color);
            width: 90%;
            max-width: 400px;
            margin-top: 80px;
            text-align: center;
        }

        #loginContainer h2 {
            color: var(--primary-dark);
            margin-bottom: 30px;
            font-size: 1.6em;
        }

        /* Dashboard Container */
        .dashboard-container {
            background: #fff;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 12px var(--shadow-color);
            width: 95%;
            max-width: 1800px;
            margin-top: 20px;
            margin-bottom: 20px;
            display: none;
        }

        /* Header del Dashboard */
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
            flex-wrap: wrap;
            gap: 15px;
        }

        .dashboard-header h2 {
            color: var(--primary-dark);
            margin-bottom: 0;
            font-size: 1.8em;
            text-align: left;
            flex-grow: 1;
        }

        /* Métricas */
        .metrics-cards-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
            flex-wrap: wrap;
            padding: 0 15px;
        }

        .metric-card {
            background: #fff;
            border-radius: 8px;
            padding: 20px;
            min-width: 200px;
            box-shadow: 0 2px 4px var(--shadow-color);
            display: flex;
            align-items: center;
            gap: 15px;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        /* Tablas */
        .table-container {
            max-width: 100vw;
            overflow-x: auto;
            width: 100%;
            box-sizing: border-box;
        }

        #dataTable, #tablaRegistros {
            width: 100%;
            border-collapse: collapse;
            background: #fff;
        }

        #dataTable th, #dataTable td,
        #tablaRegistros th, #tablaRegistros td {
            padding: 12px 10px;
            text-align: center;
            vertical-align: middle;
            font-size: 1em;
            white-space: normal;
            word-break: break-word;
            min-width: 90px;
            max-width: 220px;
        }

        /* Botones */
        button {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: .9em;
            font-weight: 500;
            transition: background-color .2s ease, box-shadow .2s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            vertical-align: middle;
            justify-content: center;
            line-height: 1.5;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: #fff;
        }

        .btn-secondary {
            background-color: var(--secondary-color);
            color: #fff;
        }

        .btn-action {
            background-color: var(--warning-color);
            color: #333;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            #dataTable th, #dataTable td {
                font-size: 0.95em;
                padding: 8px 6px;
            }
        }

        @media (max-width: 900px) {
            #dataTable th, #dataTable td {
                font-size: 0.9em;
                padding: 6px 4px;
            }
            
            .actions-cell {
                flex-direction: column;
                gap: 4px;
                min-width: 120px;
            }
            
            .actions-cell button {
                min-width: 90px;
                max-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div id="loginContainer">
        <h2><i class="fas fa-sign-in-alt icon"></i>Ingreso</h2>
        <div class="control-group">
            <label for="usernameInput"><i class="fas fa-user icon"></i>Usuario:</label>
            <input type="text" id="usernameInput" placeholder="Ingrese su usuario" required>
        </div>
        <button id="loginButton" class="btn-primary" onclick="handleLogin()">
            <i class="fas fa-arrow-right icon"></i>Ingresar
        </button>
    </div>
    <div id="dashboardContainer" class="dashboard-container">
        <div class="dashboard-header">
            <h2><i class="fas fa-tachometer-alt icon"></i>Bienvenid@s a ALMA™ - Sistema de Gestión y Control</h2>
            <div class="header-actions">
                <div id="userInfo"> <i class="fas fa-user-circle icon"></i>Cargando... </div>
                <button id="refreshButton" class="btn-refresh" onclick="refreshCurrentTabData()" title="Actualizar datos pestaña actual"> <i class="fas fa-sync-alt icon"></i> </button>
            </div>
        </div>
        <div class="metrics-cards-container">
            <div class="metric-card" id="metric-card-total">
                <i class="fas fa-tasks icon"></i>
                <div class="metric-content">
                    <h3>Total Casos Asignados</h3>
                    <p class="metric-value" id="metric-total-casos">0</p>
                </div>
            </div>
            <div class="metric-card" id="metric-card-hoy">
                <i class="fas fa-calendar-day icon"></i>
                <div class="metric-content">
                    <h3>Casos Asignados Hoy</h3>
                    <p class="metric-value" id="metric-casos-hoy">0</p>
                </div>
            </div>
            <div class="metric-card" id="metric-card-pendientes">
                <i class="fas fa-clock icon"></i>
                <div class="metric-content">
                    <h3>Casos Pendientes</h3>
                    <p class="metric-value" id="metric-casos-pendientes">0</p>
                </div>
            </div>
            <div class="metric-card" id="metric-card-eg">
                <i class="fas fa-exclamation-triangle icon"></i>
                <div class="metric-content">
                    <h3>Errores de Gestión</h3>
                    <p class="metric-value" id="metric-errores-gestion">0</p>
                </div>
            </div>
            <div class="metric-card" id="metric-card-ci">
                <i class="fas fa-user-slash icon"></i>
                <div class="metric-content">
                    <h3>Conductas Inadecuadas</h3>
                    <p class="metric-value" id="metric-conductas-inadecuadas">0</p>
                </div>
            </div>
        </div>
        <div class="tab-container">
            <button class="tab-button" data-tab-target="asignaciones" onclick="openTab(event, 'asignaciones')"><i class="fas fa-tasks icon"></i>Gestión Asignaciones</button>
            <button class="tab-button" data-tab-target="qa" onclick="openTab(event, 'qa')"><i class="fas fa-clipboard-check icon"></i>Seguimiento QA</button>
        </div>
        <div id="loading" class="loading" style="display: none; justify-content: center; align-items: center; padding: 30px;"> <i class="fas fa-spinner fa-spin"></i>Cargando datos... </div>
        <div id="asignaciones" class="tab-content">
            <h3><i class="fas fa-filter icon"></i>Filtrar Asignaciones</h3>
            <div class="controls-container">
                <div class="control-group">
                    <label for="ldapSelect"><i class="fas fa-user icon"></i>Usuario LDAP:</label>
                    <select id="ldapSelect" onchange="handleAssignmentSelectionChange()" disabled> <option value="">Cargando...</option> </select>
                </div>
                <div class="control-group">
                    <label for="teamSelect"><i class="fas fa-users-cog icon"></i>Equipo:</label>
                    <select id="teamSelect" onchange="handleAssignmentSelectionChange()" disabled> <option value="">Cargando...</option> </select>
                </div>
                <div class="control-group">
                    <label for="simpleDaySelect"><i class="fas fa-calendar-day icon"></i>Simple Day:</label>
                    <select id="simpleDaySelect" onchange="handleSimpleDayChange()" disabled> <option value="">Cargando...</option> </select>
                </div>
            </div>
            <div class="asignaciones-header-search-container">
                <h3><i class="fas fa-list-ul icon"></i>Casos Asignados</h3> <input type="text" id="asignacionesSearchInput" placeholder="Buscar por #Caso, Fecha, Simple Day, Canal..." disabled>
            </div>
            <div class="table-container">
                <table id="dataTable">
                    <thead> </thead>
                    <tbody id="dataTableBody"> <tr><td colspan="13" class="no-data">Seleccione usuario y equipo para ver asignaciones.</td></tr> </tbody>
                </table>
            </div>
        </div>
        <div id="qa" class="tab-content">
            <div id="toggleQaFormButton" class="qa-form-toggle"> <i class="fas fa-plus-circle icon"></i>Registrar Nueva Consulta QA </div>
            <div id="qaFormContainer">
                <form id="qaForm">
                    <span id="closeQaForm" class="close-qa-form" title="Cerrar formulario">&times;</span>
                    <h3><i class="fas fa-edit icon"></i>Registrar Nueva Consulta QA</h3>
                    <div class="control-group"> <label for="qaLdapQa"><i class="fas fa-user-secret icon"></i>LDAP QA (Registra):</label> <input type="text" id="qaLdapQa" required readonly> </div>
                    <div class="control-group"> <label for="qaTeam"><i class="fas fa-users icon"></i>TEAM (Caso):</label> <input type="text" id="qaTeam" required> </div>
                    <div class="control-group"> <label for="qaCaso"><i class="fas fa-hashtag icon"></i># CASO:</label> <input type="text" id="qaCaso" required> </div>
                    <div class="control-group"> <label for="qaRepEvaluar"><i class="fas fa-user-check icon"></i>REP A EVALUAR:</label> <input type="text" id="qaRepEvaluar" required> </div>
                    <div class="control-group"> <label for="qaPregunta"><i class="fas fa-question-circle icon"></i>PREGUNTA:</label> <textarea id="qaPregunta" rows="3" class="swal-input" required></textarea> </div>
                    <button type="button" class="btn-primary" onclick="guardarRegistroQA()"> <i class="fas fa-save icon"></i>Guardar Nuevo Registro </button>
                </form>
            </div>
            <div class="qa-header-search-container">
                <h3><i class="fas fa-list-alt icon"></i>Registros Guardados QA</h3>
                <input type="text" id="qaSearchInput" placeholder="Buscar por Fecha, LDAP QA, # CASO...">
            </div>
            <div class="table-container">
                <table id="tablaRegistros">
                    <thead> <tr> <th>FECHA REGISTRO</th> <th>LDAP QA</th> <th>TEAM</th> <th># CASO</th> <th>REP A EVALUAR</th> <th class="wrap">PREGUNTA</th> <th class="wrap">ESTADO</th> <th>FECHA DE RESPUESTA</th> <th class="wrap">RESPUESTA</th> <th class="text-center">VISTO FORMACIÓN</th> <th class="text-center">VISTO MELI</th> <th class="qa-actions-col"><i class="fas fa-edit icon"></i>ACCIONES</th> </tr> </thead>
                    <tbody id="qaTableBody"> <tr> <td colspan="12" class="no-data">Cargando registros QA...</td> </tr> </tbody>
                </table>
            </div>
            <div id="qaPaginationControls" class="pagination-controls"> </div>
        </div>
    </div>
    
    <!-- Scripts -->
    <script>
        // Funciones de autenticación
        function handleLogin() {
            const usernameInput = document.getElementById('usernameInput');
            const username = usernameInput.value.trim();
            if (!username) {
                Swal.fire('Error', 'Ingrese un usuario.', 'warning');
                return;
            }

            google.script.run.withSuccessHandler(response => {
                if (response && response.success && response.rol) {
                    currentUser = {
                        username: response.username,
                        nombre: response.nombre,
                        rol: response.rol
                    };

                    document.getElementById('loginContainer').style.display = 'none';
                    document.getElementById('dashboardContainer').style.display = 'block';
                    
                    document.getElementById('userInfo').innerHTML = `<i class="fas fa-user-circle icon"></i>Hola, <strong>${response.nombre}</strong> (${response.rol})`;
                    
                    initializeDashboard();
                    setMetricsLoading();
                    loadMetricsData(currentUser.username);
                } else {
                    Swal.fire('Acceso Denegado', response.message || 'Usuario no válido.', 'error');
                }
            }).withFailureHandler(error => {
                Swal.fire('Error Conexión', `Error al iniciar sesión: ${error.message}`, 'error');
            }).verificarUsuario(username);
        }

        // Funciones del dashboard
        function initializeDashboard() {
            console.log("Inicializando:", currentUser.rol);
            if (!currentUser) return;
            
            const esAdmin = currentUser.rol === 'Administrador';
            const esQA = currentUser.rol === 'QA';
            const esQS = currentUser.rol === 'QS';

            updateMetrics();

            document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c=>{c.style.display='none';c.classList.remove('active');});
            document.getElementById('qaFormContainer').style.display='none';
            
            const asignBtn=document.querySelector('.tab-button[data-tab-target="asignaciones"]');
            const qaBtn=document.querySelector('.tab-button[data-tab-target="qa"]');
            
            if(esAdmin||esQA){
                if(document.getElementById("teamSelect")) {
                    loadDropdown("getTeams", "teamSelect", "Seleccione Equipo");
                    document.getElementById("teamSelect").addEventListener('change', handleTeamChange);
                }
                if(document.getElementById("ldapSelect")) {
                    document.getElementById("ldapSelect").addEventListener('change', handleLdapChange);
                }
                if(document.getElementById("simpleDaySelect")) {
                    document.getElementById("simpleDaySelect").addEventListener('change', handleSimpleDayChange);
                }
            }
            
            let defTab='asignaciones';
            let defBtn=asignBtn;
            if(esQS){defTab='qa';defBtn=qaBtn;}
            if(defBtn&&defBtn.style.display!=='none'){openTab({currentTarget:defBtn},defTab);}
            else{
                const firstVisible=document.querySelector('.tab-button:not([style*="display: none"])');
                if(firstVisible){
                    const fallback=firstVisible.getAttribute('data-tab-target');
                    openTab({currentTarget:firstVisible},fallback);
                }
                else{
                    console.error("Ninguna pestaña visible.");
                }
            }
            console.log("Dashboard inicializado.");
        }

        function updateMetrics() {
            const metricElements = {
                totalCasos: document.getElementById('totalCasosAsignados'),
                casosHoy: document.getElementById('casosAsignadosHoy'),
                casosPendientes: document.getElementById('casosPendientes'),
                erroresGestion: document.getElementById('erroresGestion'),
                conductasInadecuadas: document.getElementById('conductasInadecuadas')
            };

            Object.values(metricElements).forEach(el => {
                if (el) el.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            });

            google.script.run
                .withSuccessHandler(metrics => {
                    if (metrics) {
                        metricElements.totalCasos.textContent = metrics.totalCasos;
                        metricElements.casosHoy.textContent = metrics.casosHoy;
                        metricElements.casosPendientes.textContent = metrics.casosPendientes;
                        metricElements.erroresGestion.textContent = metrics.erroresGestion;
                        metricElements.conductasInadecuadas.textContent = metrics.conductasInadecuadas;
                    }
                })
                .withFailureHandler(error => {
                    console.error('Error al obtener métricas:', error);
                    Object.values(metricElements).forEach(el => {
                        if (el) el.textContent = 'Error';
                    });
                })
                .getMetricsData();
        }

        // Funciones relacionadas con QA
        function guardarRegistroQA() {
            if (!currentUser) return;
            
            let ldapQa = currentUser.username;
            let team = document.getElementById("qaTeam").value.trim();
            let caso = document.getElementById("qaCaso").value.trim();
            let rep = document.getElementById("qaRepEvaluar").value.trim();
            let pregunta = document.getElementById("qaPregunta").value.trim();
            
            if (!team || !caso || !rep || !pregunta) {
                Swal.fire('Incompleto', 'Faltan campos QA', 'warning');
                return;
            }
            
            let data = [null, ldapQa, team, caso, rep, pregunta];
            
            Swal.fire({
                title: 'Guardando QA...',
                allowOutsideClick: false,
                didOpen: () => Swal.showLoading()
            });
            
            google.script.run
                .withSuccessHandler(msg => {
                    Swal.close();
                    Swal.fire('Guardado', msg, 'success');
                    limpiarFormularioQA();
                    document.getElementById('qaFormContainer').style.display = 'none';
                    cargarRegistrosDesdeSheetsQA();
                })
                .withFailureHandler(e => {
                    Swal.close();
                    Swal.fire('Error', `No se guardó QA: ${e.message}`, 'error');
                })
                .guardarEnSheetsQA(data);
        }

        function limpiarFormularioQA() {
            document.getElementById("qaTeam").value = '';
            document.getElementById("qaCaso").value = '';
            document.getElementById("qaRepEvaluar").value = '';
            document.getElementById("qaPregunta").value = '';
            if(currentUser) {
                document.getElementById('qaLdapQa').value = currentUser.username;
            }
        }

        function cargarRegistrosDesdeSheetsQA() {
            let body = document.getElementById("qaTableBody");
            if(!body) {
                setRefreshButtonState(false);
                return;
            }
            
            if(!currentUser) {
                body.innerHTML = `<tr><td colspan="12">Error usuario</td></tr>`;
                setRefreshButtonState(false);
                return;
            }
            
            const showActions = currentUser.rol === 'Administrador' || currentUser.rol === 'QS';
            const colspan = showActions ? 12 : 11;
            
            setRefreshButtonState(true);
            body.innerHTML = `<tr><td colspan="${colspan}" class="loading"><i class="fas fa-spinner fa-spin"></i> Cargando QA...</td></tr>`;
            document.getElementById("qaPaginationControls").innerHTML = '';
            document.getElementById('qaSearchInput').value = '';
            
            google.script.run
                .withSuccessHandler(data => {
                    if(!data || !Array.isArray(data) || data.length < 1) {
                        body.innerHTML = `<tr><td colspan="${colspan}" class="no-data">No hay registros QA.</td></tr>`;
                        currentQaData = [];
                        currentFilteredQaData = [];
                    } else if(data.length === 1) {
                        body.innerHTML = `<tr><td colspan="${colspan}" class="no-data">No hay registros QA.</td></tr>`;
                        currentQaData = [];
                        currentFilteredQaData = [];
                    } else {
                        currentQaData = data.slice(1);
                        currentFilteredQaData = [...currentQaData];
                        qaCurrentPage = 1;
                        displayQaPage(currentFilteredQaData);
                    }
                    setRefreshButtonState(false);
                })
                .withFailureHandler(e => {
                    console.error("Error carga QA:", e);
                    body.innerHTML = `<tr><td colspan="${colspan}" class="no-data">Error carga QA: ${e.message}</td></tr>`;
                    currentQaData = [];
                    currentFilteredQaData = [];
                    setRefreshButtonState(false);
                })
                .obtenerRegistrosQA(currentUser);
        }

        // Funciones utilitarias
        function setMetricsLoading() {
            const spinner = '<i class="fas fa-spinner fa-spin"></i>';
            const ids = [
                'assignedCasesCount',
                'closedCasesCount',
                'pendingCasesCount',
                'tmoMetric',
                'tiempoGestionMetric',
                'tiempoInactivoMetric',
                'afectacionNaCount',
                'afectacionEgCount',
                'afectacionCiCount'
            ];
            ids.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.innerHTML = spinner;
            });
        }

        function getCurrentFormattedTimestampCliente() {
            const now = new Date();
            const day = String(now.getDate()).padStart(2, '0');
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const year = now.getFullYear();
            let hours = now.getHours();
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            const ampm = hours >= 12 ? 'PM' : 'AM';
            hours = hours % 12;
            hours = hours ? hours : 12;
            const hoursStr = String(hours).padStart(2, '0');
            const strTime = `${hoursStr}:${minutes}:${seconds} ${ampm}`;
            return `${day}-${month}-${year}, ${strTime}`;
        }

        function setRefreshButtonState(isLoading) {
            const btn = document.getElementById('refreshButton');
            if (!btn) return;
            const icon = btn.querySelector('i.fas');
            btn.disabled = isLoading;
            btn.classList.toggle('loading', isLoading);
            if(icon) {
                icon.className = `fas ${isLoading ? 'fa-spinner' : 'fa-sync-alt'} icon`;
            }
        }

        function parseDateString(dateString) {
            if (!dateString || typeof dateString !== 'string') return null;
            dateString = dateString.trim();
            let date = null;
            
            let matchDateOnly = dateString.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
            if (matchDateOnly) {
                try {
                    let day = parseInt(matchDateOnly[1], 10);
                    let month = parseInt(matchDateOnly[2], 10) - 1;
                    let year = parseInt(matchDateOnly[3], 10);
                    date = new Date(Date.UTC(year, month, day));
                    if (isNaN(date.getTime())) date = null;
                } catch(e) {
                    date = null;
                }
            }
            
            if (!date) {
                let matchDateTime = dateString.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})[,\s]+(\d{1,2}):(\d{2}):(\d{2})\s*(AM|PM)/i);
                if (matchDateTime) {
                    try {
                        let day = parseInt(matchDateTime[1], 10);
                        let month = parseInt(matchDateTime[2], 10) - 1;
                        let year = parseInt(matchDateTime[3], 10);
                        let hour = parseInt(matchDateTime[4], 10);
                        let minute = parseInt(matchDateTime[5], 10);
                        let second = parseInt(matchDateTime[6], 10);
                        let ampm = matchDateTime[7].toUpperCase();
                        
                        if (ampm === 'PM' && hour < 12) hour += 12;
                        if (ampm === 'AM' && hour === 12) hour = 0;
                        
                        date = new Date(Date.UTC(year, month, day, hour, minute, second));
                        if (isNaN(date.getTime())) date = null;
                    } catch (e) {
                        date = null;
                    }
                }
            }
            
            if (!date) {
                try {
                    let tempDate = new Date(dateString);
                    if (!isNaN(tempDate.getTime())) date = tempDate;
                } catch(e) {}
            }
            
            return date;
        }
    </script>
</body>
</html>