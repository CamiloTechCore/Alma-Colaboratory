<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ALMA™</title>
  <link rel="icon" href="https://drive.google.com/file/d/1dolNUBBxqATuCEZpt05bgKSzQL1tO4fA/view?usp=sharing">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" xintegrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    /* --- Estilos Generales y de Login --- */
    body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background-color:#f0f2f5;margin:0;padding:0;display:flex;justify-content:center;align-items:flex-start;min-height:100vh}
    #loginContainer{background:#fff;padding:40px;border-radius:10px;box-shadow:0 4px 12px rgba(0,0,0,.15);width:90%;max-width:400px;margin-top:80px;text-align:center}
    #loginContainer h2{color:#1a237e;margin-bottom:30px;font-size:1.6em}
    #loginContainer .control-group{margin-bottom:20px;text-align:left}
    #loginContainer label{display:block;margin-bottom:8px;font-weight:700;color:#343a40;font-size:.95em;display:flex;align-items:center;gap:6px}
    #loginContainer input[type=text], #loginContainer input[type=password], #loginContainer select {width:100%;padding:12px 15px;border-radius:5px;border:1px solid #ced4da;font-size:1em;box-sizing:border-box;transition:border-color .2s ease,box-shadow .2s ease}
    #loginContainer input[type=text]:focus, #loginContainer input[type=password]:focus, #loginContainer select:focus {border-color:#80bdff;outline:0;box-shadow:0 0 0 .2rem rgba(0,123,255,.25)}
    #loginContainer button{width:100%;padding:12px 15px;font-size:1.1em}
    #password-group {display: none;}
    
    /* --- Contenedor Principal del Dashboard --- */
    .dashboard-container{
        background:#fff;
        padding:25px;
        border-radius:10px;
        box-shadow:0 4px 12px rgba(0,0,0,.1);
        width:100%;
        max-width:100vw;
        margin-top:20px;
        margin-bottom:20px;
        display:none
    }
    .role-administrador{} .role-qa{} .role-qs{}
    
    /* --- Header del Dashboard --- */
    .dashboard-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:15px;border-bottom:1px solid #eee;flex-wrap:wrap;gap:15px}
    .dashboard-header h2{color:#1a237e;margin:0;font-size:1.8em;text-align:left;flex-grow:1}
    #userInfo{font-size:.95em;color:#555;background-color:#e9ecef;padding:8px 15px;border-radius:5px;text-align:right;white-space:nowrap}
    #userInfo .icon{margin-right:6px;color:#007bff}
    .header-actions{display:flex;align-items:center;gap:15px}
    .btn-refresh{background-color:#6c757d;color:#fff;padding:5px 10px;font-size:.9em;line-height:1.2;border-radius:50%;width:32px;height:32px;display:inline-flex;justify-content:center;align-items:center}
    .btn-refresh:hover:not(:disabled){background-color:#5a6268;box-shadow:0 2px 5px rgba(0,0,0,.1)}
    .btn-refresh.loading .fa-sync-alt{animation:fa-spin 1.5s infinite linear}
    h3{color:#333;margin-top:20px;margin-bottom:15px;border-bottom:1px solid #eee;padding-bottom:8px;display:flex;align-items:center;font-size:1.4em}
    h3 .icon{margin-right:10px;color:#007bff}

    /* --- Pestañas (Tabs) --- */
    .tab-container{display:flex;border-bottom:2px solid #dee2e6;margin-bottom:25px;flex-wrap:wrap}
    .tab-button{padding:12px 25px;cursor:pointer;border:none;background-color:transparent;font-size:1.1em;font-weight:600;color:#495057;border-bottom:3px solid transparent;transition:all .3s ease;display:inline-flex;align-items:center;gap:8px;white-space:nowrap}
    .tab-button:hover{background-color:#e9ecef;color:#0d47a1}
    .tab-button.active{color:#1a237e;border-bottom:3px solid #1a237e}
    .tab-content{display:none;padding:15px 0;animation:fadeIn .5s ease-in-out}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    .tab-content.active{display:block}
    
    /* Visibilidad por Roles */
    .role-qs .tab-button[data-tab-target=asignaciones],.role-qs #asignaciones{display:none!important}
    .role-qs #toggleQaFormButton,.role-qs #qaFormContainer{display:none!important}

    /* --- Controles y Formularios --- */
    .controls-container{display:flex;gap:20px;margin-bottom:25px;flex-wrap:wrap;background:#f8f9fa;padding:20px;border-radius:8px;border:1px solid #e9ecef}
    .control-group{flex:1;min-width:220px}
    label{display:block;margin-bottom:8px;font-weight:700;color:#343a40;font-size:.95em;display:flex;align-items:center;gap:6px}
    label .icon{color:#555}
    select,input[type=text],input[type=number],input[type=datetime-local],textarea{width:100%;padding:10px 12px;border-radius:5px;border:1px solid #ced4da;font-size:1em;box-sizing:border-box;transition:border-color .2s ease,box-shadow .2s ease}
    input[readonly]{background-color:#e9ecef;cursor:not-allowed}
    select:focus,input:not([readonly]):focus,textarea:focus,input[type=number]:focus{border-color:#80bdff;outline:0;box-shadow:0 0 0 .2rem rgba(0,123,255,.25)}
    #advancedFiltersContainer{gap:15px;align-items:flex-end;}
    #advancedFiltersContainer .control-group{margin-bottom:0;}

    /* --- Estilos Multi-Select --- */
    .multiselect-container{position:relative}
    .multiselect-display{background-color:#fff;border:1px solid #ced4da;border-radius:5px;padding:10px 12px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;font-size:1em;height:42.5px;box-sizing:border-box;}
    .multiselect-display-text{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .multiselect-options{display:none;position:absolute;background-color:#fff;border:1px solid #ddd;border-radius:5px;max-height:200px;overflow-y:auto;z-index:1000;width:100%;box-shadow:0 4px 8px rgba(0,0,0,.1);margin-top:2px}
    .multiselect-options label{display:block;padding:8px 12px;cursor:pointer;font-weight:400;font-size:0.95em}
    .multiselect-options label:hover{background-color:#f0f2f5}
    .multiselect-options input[type=checkbox]{margin-right:8px}
    
    /* --- Estilos de Tablas --- */
    .table-container{
        max-height:650px;
        overflow-y:auto;
        overflow-x:auto;
        margin-top:20px;
        border:1px solid #dee2e6;
        border-radius:8px;
        box-shadow:0 2px 5px rgba(0,0,0,.07);
        width:100%;
        box-sizing:border-box
    }
    table{width:100%;border-collapse:collapse;background:#fff}
    th{color:#fff;position:sticky;top:0;z-index:1;font-weight:600;vertical-align:middle}
    tr:nth-child(even){background-color:#f8f9fa}
    tr:hover{background-color:#e2e6ea}

    /* --- Estilos Pestaña Asignaciones --- */
    .asignaciones-header-search-container{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;flex-wrap:wrap;gap:15px}
    .asignaciones-header-search-container h3{margin:0;border-bottom:none;padding-bottom:0;flex-grow:1}
    #asignacionesSearchInput{padding:8px 12px;border:1px solid #ced4da;border-radius:5px;font-size:.95em;width:100%;max-width:400px;box-sizing:border-box}
    #asignacionesSearchInput:focus{border-color:#80bdff;outline:0;box-shadow:0 0 0 .2rem rgba(0,123,255,.25)}
    #dataTable{table-layout:fixed;word-wrap:break-word}
    #dataTable th{background:#007bff}
    #dataTable th,#dataTable td{border:1px solid #e9ecef;padding:10px 12px;text-align:left;font-size:.88em;vertical-align:middle;white-space:normal;overflow-wrap:break-word;overflow:hidden;text-overflow:ellipsis}
    #dataTable td a{color:#007bff;text-decoration:none;cursor:pointer;display:inline-block;padding:2px 5px}
    #dataTable td a:hover{text-decoration:underline;color:#0056b3}
    #dataTable .actions-cell{text-align:center;white-space:nowrap;overflow:visible}
    #dataTable tr.overdue-case{background-color:#f8d7da!important;font-weight:700}
    #dataTable tr.overdue-case:hover{background-color:#f1c6cb!important}
    #dataTable tr.overdue-case:nth-child(even){background-color:#f8d7da!important}
    .repeated-case-highlight { background-color: #d4edda !important; }

    /* --- Estilos Pestaña Seguimiento QA --- */
    .qa-header-search-container{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;flex-wrap:wrap;gap:15px}
    .qa-header-search-container h3{margin:0;border-bottom:none;padding-bottom:0}
    #qaSearchInput{padding:8px 12px;border:1px solid #ced4da;border-radius:5px;font-size:.95em;width:100%;max-width:350px;box-sizing:border-box}
    #qaSearchInput:focus{border-color:#80bdff;outline:0;box-shadow:0 0 0 .2rem rgba(0,123,255,.25)}
    #toggleQaFormButton{display:inline-block;padding:10px 20px;margin-bottom:15px;background-color:#e9ecef;color:#1a237e;border:1px solid #ced4da;border-radius:5px;cursor:pointer;transition:background-color .3s ease,box-shadow .3s ease;font-weight:600;font-size:1.05em}
    #toggleQaFormButton:hover{background-color:#dee2e6;box-shadow:0 2px 4px rgba(0,0,0,.1)}
    #qaFormContainer{display:none;margin-bottom:25px;background:#f8f9fa;padding:30px;border-radius:8px;box-shadow:inset 0 1px 4px rgba(0,0,0,.06);max-width:800px;margin:20px auto;text-align:left;border:1px solid #e0e0e0;position:relative}
    #closeQaForm{position:absolute;top:10px;right:15px;font-size:2em;color:#6c757d;cursor:pointer;line-height:1;transition:color .2s ease;font-weight:700}
    #closeQaForm:hover{color:#343a40}
    #qaForm .control-group{margin-bottom:18px}
    #qaForm label{font-size:.9em}
    #qaForm input,#qaForm select,#qaForm textarea{width:100%;box-sizing:border-box}
    #qaForm button.btn-primary{margin-top:15px;width:100%;padding:12px 18px;font-size:1em}
    #tablaRegistros{table-layout:fixed;word-wrap:break-word}
    #tablaRegistros th{background:#009ee3}
    #tablaRegistros th,#tablaRegistros td{border:1px solid #e9ecef;padding:10px 12px;text-align:left;font-size:.88em;vertical-align:middle;white-space:normal;overflow-wrap:break-word}
    #tablaRegistros th:nth-child(1){width:9%}#tablaRegistros th:nth-child(2){width:6%}#tablaRegistros th:nth-child(3){width:6%}#tablaRegistros th:nth-child(4){width:7%}#tablaRegistros th:nth-child(5){width:6%}#tablaRegistros th:nth-child(6){width:7%}#tablaRegistros th:nth-child(7){width:12%}#tablaRegistros th:nth-child(8){width:8%}#tablaRegistros th:nth-child(9){width:9%}#tablaRegistros th:nth-child(10){width:12%}#tablaRegistros th:nth-child(11){width:12%}#tablaRegistros th:nth-child(12),#tablaRegistros th:nth-child(13){width:4%;text-align:center}
    #tablaRegistros td:nth-child(12),#tablaRegistros td:nth-child(13){text-align:center}
    .qa-actions-col{width:7%;text-align:center}
    #tablaRegistros th.qa-actions-col, #tablaRegistros td.qa-actions-col{display:none}
    .role-administrador #tablaRegistros th.qa-actions-col, .role-administrador #tablaRegistros td.qa-actions-col, .role-qs #tablaRegistros th.qa-actions-col, .role-qs #tablaRegistros td.qa-actions-col{display:table-cell}
    
    /* --- Paginación --- */
    .pagination-controls{display:flex;justify-content:center;align-items:center;padding:15px 0;margin-top:10px}
    .pagination-controls button{background-color:#f0f2f5;border:1px solid #ced4da;color:#007bff;padding:8px 12px;margin:0 3px;cursor:pointer;transition:background-color .2s ease,color .2s ease;border-radius:4px;font-size:.9em;min-width:35px;height:35px;line-height:1}
    .pagination-controls button:hover:not(:disabled){background-color:#e2e6ea}
    .pagination-controls button:disabled{color:#6c757d;cursor:not-allowed;opacity:.6}
    .pagination-controls button.active{background-color:#007bff;color:#fff;border-color:#007bff;font-weight:700}
    .pagination-info{margin:0 15px;font-size:.9em;color:#555}

    /* --- Utilidades Generales --- */
    .loading,.no-data{text-align:center;padding:40px;font-style:italic;color:#6c757d;font-size:1.1em}
    .loading i{margin-right:10px;font-size:1.2em;animation:fa-spin 2s infinite linear}
    @keyframes fa-spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
    .icon{margin-right:8px}
    button{padding:8px 15px;border:none;border-radius:5px;cursor:pointer;font-size:.9em;font-weight:500;transition:background-color .2s ease,box-shadow .2s ease;display:inline-flex;align-items:center;gap:6px;vertical-align:middle;justify-content:center;line-height:1.5}
    button:disabled{background-color:#ccc!important;color:#666!important;cursor:not-allowed!important;box-shadow:none!important;opacity:.7}
    button:disabled .fa-spinner{animation:fa-spin 1.5s infinite linear}
    button.btn-primary{background-color:#007bff;color:#fff} button.btn-primary:hover:not(:disabled){background-color:#0056b3}
    button.btn-secondary { background-color: #6c757d; color: #fff; } button.btn-secondary:hover:not(:disabled) { background-color: #5a6268; }
    button.btn-action-unified { background-color: #28a745; color: white; } button.btn-action-unified:hover:not(:disabled) { background-color: #218838; }
    button.btn-edit { background-color: #ffc107; color: #333; } button.btn-edit:hover:not(:disabled) { background-color: #e0a800; }

    /* --- Estilos para Popups (SweetAlert) --- */
    .swal2-popup{font-size:1rem!important;border-radius:8px!important;max-width: 750px;}
    .swal-label{display:block;margin-bottom:5px;font-weight:700;color:#555;text-align:left}
    .swal-input,.swal-select{width:100%!important;padding:10px;margin-bottom:15px;border:1px solid #ccc;border-radius:4px;box-sizing:border-box;font-size:1em}
    textarea.swal-input{min-height:80px;resize:vertical}
    .swal-gestion-subtitle{font-weight:700;margin-top:20px;margin-bottom:10px;color:#1a237e;border-bottom:1px solid #eee;padding-bottom:5px}
    .swal-gestion-list{padding-left:0;margin-top:5px;list-style:none}
    .swal-gestion-list li{margin-bottom:12px;display:flex;align-items:center}
    .swal-gestion-list input[type=checkbox]{margin-right:10px;cursor:pointer;transform:scale(1.1)}
    .swal-gestion-list label{margin-bottom:0;font-weight:400;cursor:pointer;flex-grow: 1;}
    .swal-qa-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-top:15px}
    .ci-tl-item-container {display: flex; align-items: center; gap: 5px; background-color: #fff3cd; padding: 8px; border-radius: 5px; border: 1px solid #ffeeba;}
    .ci-tl-item-container input[type=checkbox]{margin-right: 2px;}
    .ci-tl-item-container label {margin-right: 10px; flex-grow: 0;}
    .ci-tl-item-container span { flex-grow: 1; font-weight: 500;}

    /* --- NUEVOS ESTILOS PARA EL BOTÓN DE ACTUALIZAR USUARIOS --- */
    /* Ocultar el botón por defecto */
    #clearUserListBtn {
        display: none;
    }
    /* Mostrar el botón solo si el cuerpo tiene la clase del rol administrador */
    .role-administrador #clearUserListBtn {
        display: inline-flex; /* o 'block' según el estilo deseado */
    }
  </style>
</head>
<body>
  <div id="loginContainer">
    <h2><i class="fas fa-sign-in-alt icon"></i>Ingreso</h2>
    <div class="control-group">
      <label for="roleSelect"><i class="fas fa-user-shield icon"></i>Seleccione su Rol:</label>
      <select id="roleSelect" onchange="togglePasswordField()">
        <option value="QA">QA</option>
        <option value="Administrador">Administrador</option>
        <option value="QS">QS</option>
      </select>
    </div>
    <div class="control-group">
      <label for="usernameInput"><i class="fas fa-user icon"></i>Usuario:</label>
      <input type="text" id="usernameInput" placeholder="Ingrese su usuario" required>
    </div>
    <div class="control-group" id="password-group">
      <label for="passwordInput"><i class="fas fa-key icon"></i>Contraseña:</label>
      <input type="password" id="passwordInput" placeholder="Ingrese su contraseña">
    </div>
    <button id="loginButton" class="btn-primary" onclick="handleLogin()">
      <i class="fas fa-arrow-right icon"></i>Ingresar
    </button>
  </div>
  <div id="dashboardContainer" class="dashboard-container">
     <div class="dashboard-header">
        <h2><i class="fas fa-tachometer-alt icon"></i>ALMA™ - Sistema de Gestión y Control</h2>
        <div class="header-actions">
           <div id="userInfo"> <i class="fas fa-user-circle icon"></i>Cargando... </div>
           <button id="clearUserListBtn" class="btn-secondary" title="Actualizar la lista de Usuarios LDAP desde el origen">
              <i class="fas fa-users-cog icon"></i> Actualizar Usuarios
           </button>
           <button id="refreshButton" class="btn-refresh" onclick="refreshCurrentTabData()" title="Actualizar datos pestaña actual"> <i class="fas fa-sync-alt icon"></i> </button>
        </div>
     </div>
    <div class="tab-container">
       <button class="tab-button active" data-tab-target="asignaciones" onclick="openTab(event, 'asignaciones')"><i class="fas fa-tasks icon"></i>Gestión Asignaciones</button>
       <button class="tab-button" data-tab-target="qa" onclick="openTab(event, 'qa')"><i class="fas fa-clipboard-check icon"></i>Seguimiento QA</button>
     </div>
     
    <div id="asignaciones" class="tab-content active">
        <h3><i class="fas fa-filter icon"></i>Filtrar Asignaciones</h3>
        <div class="controls-container">
            <div class="control-group">
              <label for="ldapSelect"><i class="fas fa-user icon"></i>Usuario LDAP:</label>
              <select id="ldapSelect" onchange="handleAssignmentSelectionChange()" disabled> <option value="">Cargando...</option> </select>
           </div>
            <div class="control-group">
              <label for="teamSelect"><i class="fas fa-users-cog icon"></i>Equipo:</label>
              <select id="teamSelect" onchange="handleAssignmentSelectionChange()" disabled> <option value="">Cargando...</option> </select>
            </div>
        </div>
        
        <div id="advancedFiltersContainer" class="controls-container" style="display: none;">
            <div class="control-group">
                <label for="filterSampleDate"><i class="fas fa-calendar-alt icon"></i>Sample Date:</label>
                <select id="filterSampleDate" class="filter-control"></select>
            </div>
            <div class="control-group">
                <label for="filterCanal"><i class="fas fa-broadcast-tower icon"></i>Canal:</label>
                <select id="filterCanal" class="filter-control"></select>
            </div>
            <div class="control-group" id="filterProceso">
                <label><i class="fas fa-project-diagram icon"></i>Proceso:</label>
            </div>
            <div class="control-group" id="filterTipodeaccion">
                <label><i class="fas fa-tasks icon"></i>Tipo de accion:</label>
            </div>
             <div class="control-group" id="filterOficina">
                <label><i class="fas fa-building icon"></i>Oficina:</label>
            </div>
            <div class="control-group" style="flex: 0 0 auto;">
                <button id="clearFiltersBtn" class="btn-secondary"><i class="fas fa-eraser icon"></i>Limpiar</button>
            </div>
        </div>

        <div class="asignaciones-header-search-container">
            <h3><i class="fas fa-list-ul icon"></i>Casos Asignados</h3>
            <input type="text" id="asignacionesSearchInput" placeholder="Buscar en resultados filtrados...">
        </div>
        <div class="table-container">
            <table id="dataTable">
              <thead></thead>
              <tbody id="dataTableBody"> <tr><td colspan="12" class="no-data">Seleccione usuario y equipo para ver asignaciones.</td></tr> </tbody>
             </table>
         </div>
    </div>
    <div id="qa" class="tab-content">
        <div id="toggleQaFormButton">
            <i class="fas fa-plus-circle icon"></i>Registrar Nueva Consulta QA
        </div>

        <div id="qaFormContainer">
            <form id="qaForm">
            <span id="closeQaForm" title="Cerrar formulario">&times;</span>
            <h3><i class="fas fa-edit icon"></i>Registrar Nueva Consulta QA</h3>
            <div class="control-group">
                <label for="qaLdapQa"><i class="fas fa-user-secret icon"></i>LDAP QA (Registra):</label>
                <input type="text" id="qaLdapQa" required readonly>
            </div>
            <div class="control-group">
                <label for="qaTeam"><i class="fas fa-users icon"></i>TEAM:</label>
                <input type="text" id="qaTeam" required>
            </div>
            <div class="control-group">
                <label for="qaProceso"><i class="fas fa-project-diagram icon"></i>PROCESO:</label>
                <input type="text" id="qaProceso" required>
            </div>
            <div class="control-group">
                <label for="qaCaso"><i class="fas fa-hashtag icon"></i>Interacción:</label>
                <input type="text" id="qaCaso" required>
            </div>
            <div class="control-group">
                <label for="qaRepEvaluar"><i class="fas fa-user-check icon"></i>REP A EVALUAR:</label>
                <input type="text" id="qaRepEvaluar" required>
            </div>
            <div class="control-group">
                <label for="qaPregunta"><i class="fas fa-question-circle icon"></i>PREGUNTA:</label>
                <textarea id="qaPregunta" rows="3" required></textarea>
            </div>
            <button type="button" id="saveQaRecordButton" class="btn-primary" onclick="guardarRegistroQA()">
                <i class="fas fa-save icon"></i>Guardar Nuevo Registro
            </button>
            </form>
        </div>

        <div id="filtros-formador" class="controls-container" style="margin-bottom: 15px;">
            <div class="control-group">
                <label for="qaEstadoFilter"><i class="fas fa-filter icon"></i>Filtrar por Estado:</label>
                <select id="qaEstadoFilter" onchange="filterAndDisplayQaData()">
                    <option value="">Todos los estados</option>
                    <option value="Pendiente de revisión">Pendiente de revisión</option>
                    <option value="Revisado Formación">Revisado Formación</option>
                    <option value="Revisado QS">Revisado QS</option>
                </select>
            </div>
            <div class="control-group">
                <label for="qaFechaRegistroFilter"><i class="fas fa-calendar-alt icon"></i>Filtrar por Fecha de Registro:</label>
                <select id="qaFechaRegistroFilter">
                    <option value="">Todas las fechas</option>
                </select>
            </div>
            <div class="control-group" style="flex: 0 0 auto;">
                <button id="clearQaFiltersBtn" class="btn-secondary" onclick="clearQaFilters()">
                    <i class="fas fa-eraser icon"></i>Limpiar Filtros
                </button>
            </div>
        </div>
        <div class="table-container">
            <table id="tablaRegistros">
            <thead>
                <tr>
                <th>FECHA REGISTRO</th>
                <th>LDAP QA</th>
                <th>TEAM</th>
                <th>PROCESO QA</th>
                <th>Interacción</th>
                <th>REP A EVALUAR</th>
                <th>PREGUNTA</th>
                <th>ESTADO</th>
                <th>FECHA DE RESPUESTA</th>
                <th>RESPUESTA</th>
                <th>RESPUESTA QS</th>
                <th class="text-center">VISTO FORMACIÓN</th>
                <th class="text-center">VISTO MELI</th>
                <th class="qa-actions-col"><i class="fas fa-edit icon"></i>ACCIONES</th>
                </tr>
            </thead>
            <tbody id="qaTableBody">
                <tr>
                <td colspan="14" class="no-data">Cargando registros QA...</td>
                </tr>
            </tbody>
            </table>
        </div>
        <div id="qaPaginationControls" class="pagination-controls"></div>
    </div>
  </div>
  <script>
    // --- Estado Global y Variables ---
    let currentUser = null;
    let qaDataLoaded = false;
    let qaCurrentPage = 1;
    const itemsPerPageQA = 10;
    let currentQaData = [];
    let currentFilteredQaData = [];
    let notificationInterval = null;
    
    let allAssignmentsData = [];
    let assignmentsHeaders = [];
    let g_casosAResaltar = new Set();

    // --- Lógica de Login y Navegación ---
    function togglePasswordField() {
      const role = document.getElementById('roleSelect').value;
      const passwordGroup = document.getElementById('password-group');
      // --- MODIFICACIÓN AQUÍ: Se añade 'QA' a la condición para mostrar la contraseña ---
      passwordGroup.style.display = (role === 'Administrador' || role === 'QS' || role === 'QA') ? 'block' : 'none';
    }

    function handleLogin() {
        const role = document.getElementById('roleSelect').value;
        const username = document.getElementById('usernameInput').value.trim();
        const password = document.getElementById('passwordInput').value;
        const loginButton = document.getElementById('loginButton');

        if (!username) {
            Swal.fire('Error', 'Por favor, ingrese un nombre de usuario.', 'warning');
            return;
        }
        // --- MODIFICACIÓN AQUÍ: Se añade 'QA' a la validación de contraseña obligatoria ---
        if ((role === 'Administrador' || role === 'QS' || role === 'QA') && !password) {
            Swal.fire('Error', 'Por favor, ingrese su contraseña.', 'warning');
            return;
        }

        setButtonLoadingState(loginButton, true, null, 'Verificando...');
        
        google.script.run
            .withSuccessHandler(response => {
                setButtonLoadingState(loginButton, false, '<i class="fas fa-arrow-right icon"></i>Ingresar');
                if (response && response.success && response.rol) {
                   currentUser = response;
                   document.getElementById('loginContainer').style.display = 'none';
                   document.getElementById('dashboardContainer').style.display = 'block';
                   document.getElementById('userInfo').innerHTML = `<i class="fas fa-user-circle icon"></i>Hola, <strong>${currentUser.nombre}</strong> (${currentUser.rol})`;
                   document.body.className = `role-${String(currentUser.rol).toLowerCase()}`;
                   initializeDashboard();
                   
                   if (notificationInterval) clearInterval(notificationInterval);
                   checkForNotifications();
                   notificationInterval = setInterval(checkForNotifications, 30000);
                   
                } else {
                    Swal.fire('Acceso Denegado', response.message || 'Usuario no válido o contraseña incorrecta.', 'error');
                }
            })
            .withFailureHandler(error => {
                setButtonLoadingState(loginButton, false, '<i class="fas fa-arrow-right icon"></i>Ingresar');
                Swal.fire('Error de Conexión', `Error al iniciar sesión: ${error.message}`, 'error');
            })
            .verificarUsuario(username, password, role);
    }

    function openTab(evt, tabName) {
        if (currentUser && currentUser.rol === 'QS' && tabName === 'asignaciones') return;
        document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
        document.querySelectorAll('.tab-button').forEach(tb => tb.classList.remove('active'));
        document.getElementById(tabName).classList.add('active');
        evt.currentTarget.classList.add('active');

        if (tabName === 'qa' && !qaDataLoaded) {
            cargarRegistrosDesdeSheetsQA();
            qaDataLoaded = true;
        }
    }

    // --- Funciones de Inicialización ---
    function initializeDashboard() {
        const defaultTab = currentUser.rol === 'QS' ? 'qa' : 'asignaciones';
        const tabButton = document.querySelector(`.tab-button[data-tab-target="${defaultTab}"]`);
        openTab({ currentTarget: tabButton }, defaultTab);
        
        if (currentUser.rol !== 'QS') {
            loadDropdown("getLDAPUsers", "ldapSelect", "Seleccione Usuario LDAP");
            loadDropdown("getTeams", "teamSelect", "Seleccione Equipo");
            document.getElementById('asignacionesSearchInput').addEventListener('input', filterAndDisplayAssignments);
            document.getElementById('clearFiltersBtn').addEventListener('click', clearAllFilters);
        }

        if (currentUser) {
            const qaLdapInput = document.getElementById('qaLdapQa');
            if(qaLdapInput) qaLdapInput.value = currentUser.username;
        }
        
        const toggleBtn = document.getElementById('toggleQaFormButton');
        if(toggleBtn) toggleBtn.addEventListener('click', () => {
            const qaFormContainer = document.getElementById('qaFormContainer');
            qaFormContainer.style.display = qaFormContainer.style.display === 'none' ? 'block' : 'none';
            if (qaFormContainer.style.display === 'block') qaFormContainer.scrollIntoView({ behavior: 'smooth' });
        });

        const closeBtn = document.getElementById('closeQaForm');
        if(closeBtn) closeBtn.addEventListener('click', () => {
            document.getElementById('qaFormContainer').style.display = 'none';
            limpiarFormularioQA();
        });
        
        const searchInput = document.getElementById('qaSearchInput');
        if(searchInput) searchInput.addEventListener('input', function() { filterAndDisplayQaData(this.value); });
        
        // --- NUEVA LÓGICA PARA EL BOTÓN DE LIMPIAR CACHÉ ---
        if (currentUser.rol === 'Administrador') {
            const clearCacheButton = document.getElementById('clearUserListBtn');
            if(clearCacheButton) {
                clearCacheButton.addEventListener('click', handleClearUserCache);
            }
        }
    }
    
    // --- NUEVA FUNCIÓN PARA MANEJAR LA LIMPIEZA DE CACHÉ ---
    function handleClearUserCache() {
        const clearButton = document.getElementById('clearUserListBtn');
        Swal.fire({
            title: '¿Confirmar acción?',
            text: "Esto forzará la recarga de la lista de usuarios LDAP desde la hoja de cálculo. ¿Desea continuar?",
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'Sí, actualizar',
            cancelButtonText: 'Cancelar',
            confirmButtonColor: '#28a745',
        }).then((result) => {
            if (result.isConfirmed) {
                setButtonLoadingState(clearButton, true, null, 'Actualizando...');

                google.script.run
                    .withSuccessHandler(response => {
                        setButtonLoadingState(clearButton, false, '<i class="fas fa-users-cog icon"></i> Actualizar Usuarios');
                        if (response && response.success) {
                            Swal.fire({ icon: 'success', title: '¡Éxito!', text: 'Lista de usuarios recargada.', toast: true, position: 'top-end', showConfirmButton: false, timer: 3000 });
                            // Paso CRÍTICO: Volver a cargar el dropdown con los datos frescos del servidor
                            loadDropdown("getLDAPUsers", "ldapSelect", "Seleccione Usuario LDAP");
                        } else {
                            Swal.fire('Error', response.message || 'Ocurrió un error desconocido.', 'error');
                        }
                    })
                    .withFailureHandler(error => {
                        setButtonLoadingState(clearButton, false, '<i class="fas fa-users-cog icon"></i> Actualizar Usuarios');
                        Swal.fire('Error de Conexión', `No se pudo limpiar la caché: ${error.message}`, 'error');
                    })
                    .limpiarCacheUsuariosLDAP();
            }
        });
    }

    function loadDropdown(endpoint, elementId, placeholder) {
        const select = document.getElementById(elementId);
        select.innerHTML = `<option value="">Cargando...</option>`;
        select.disabled = true;
        google.script.run
            .withSuccessHandler(data => {
                select.innerHTML = `<option value="">${placeholder}</option>${(data || []).map(item => `<option value="${item}">${item}</option>`).join('')}`;
                select.disabled = false;
            })
            .withFailureHandler(error => {
                select.innerHTML = `<option value="">Error al cargar</option>`;
                Swal.fire('Error de Carga', `No se pudo cargar: ${error.message}`, 'error');
            })
            [endpoint]();
    }
    
    document.addEventListener("DOMContentLoaded", function() {
        document.getElementById('loginContainer').style.display = 'block';
        document.getElementById('passwordInput').addEventListener('keypress', e => e.key === 'Enter' && handleLogin());
        document.getElementById('usernameInput').addEventListener('keypress', e => e.key === 'Enter' && handleLogin());
        document.getElementById('usernameInput').focus();
        togglePasswordField();
    });

    // --- Funciones Generales y de UI ---
    function setButtonLoadingState(button, isLoading, originalHtml, loadingText = 'Cargando...') {
        if (!button) return;
        if (isLoading) {
            button.dataset.originalHtml = button.innerHTML;
            button.disabled = true;
            button.innerHTML = `<i class="fas fa-spinner fa-spin icon"></i>${loadingText}`;
        } else {
            button.disabled = false;
            button.innerHTML = originalHtml || button.dataset.originalHtml || 'Acción';
        }
    }

    function refreshCurrentTabData() {
        const activeTab = document.querySelector('.tab-button.active');
        if (!activeTab) return;
        const tabTarget = activeTab.getAttribute('data-tab-target');
        setRefreshButtonState(true);
        if (tabTarget === 'asignaciones') {
            handleAssignmentSelectionChange();
        } else if (tabTarget === 'qa') {
            cargarRegistrosDesdeSheetsQA();
        }
    }
    
    function setRefreshButtonState(isLoading) {
        const btn = document.getElementById('refreshButton');
        if (!btn) return;
        btn.disabled = isLoading;
        btn.classList.toggle('loading', isLoading);
        if(!isLoading) setTimeout(() => btn.classList.remove('loading'), 1000);
    }
    
    function findHeaderIndex(headersArray, headerName) {
        const cleanedHeaderName = headerName.trim().toLowerCase();
        for (let i = 0; i < headersArray.length; i++) {
            if (String(headersArray[i]).trim().toLowerCase() === cleanedHeaderName) {
                return i;
            }
        }
        return -1;
    }

    function parseDateString(dateString) {
      if (!dateString || typeof dateString !== 'string') return null;
      const cleanedString = dateString.trim();
      
      const matchDateTime = cleanedString.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4}),?\s*(\d{1,2}):(\d{2}):(\d{2})\s*(AM|PM)$/i);
      if (matchDateTime) {
        try {
          const day = parseInt(matchDateTime[1], 10);
          const month = parseInt(matchDateTime[2], 10) - 1;
          const year = parseInt(matchDateTime[3], 10);
          let hour = parseInt(matchDateTime[4], 10);
          const minute = parseInt(matchDateTime[5], 10);
          const second = parseInt(matchDateTime[6], 10);
          const ampm = matchDateTime[7].toUpperCase();

          if (ampm === 'PM' && hour < 12) hour += 12;
          if (ampm === 'AM' && hour === 12) hour = 0;
          
          return new Date(year, month, day, hour, minute, second);
        } catch(e) { return null; }
      }

      const matchDateOnly = cleanedString.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
      if (matchDateOnly) {
          try {
            const day = parseInt(matchDateOnly[1], 10);
            const month = parseInt(matchDateOnly[2], 10) - 1;
            const year = parseInt(matchDateOnly[3], 10);
            return new Date(year, month, day);
          } catch(e) { return null; }
      }
      
      return null;
    }


    // --- Lógica Pestaña Asignaciones ---
    function handleAssignmentSelectionChange() {
        const ldap = document.getElementById("ldapSelect").value;
        const team = document.getElementById("teamSelect").value;
        if (ldap && team) {
            loadAssignments(ldap, team);
        } else {
             document.getElementById('advancedFiltersContainer').style.display = 'none';
        }
    }
    
    function loadAssignments(ldap, team) {
        const tableBody = document.getElementById("dataTableBody");
        tableBody.innerHTML = `<tr><td colspan="12" class="no-data"><i class="fas fa-spinner fa-spin icon"></i> Cargando...</td></tr>`;
        setRefreshButtonState(true);

        google.script.run
            .withSuccessHandler(response => {
                setRefreshButtonState(false);
                if (!response || !response.headers || !response.data) {
                    tableBody.innerHTML = `<tr><td colspan="12" class="no-data">Error: Respuesta inválida del servidor.</td></tr>`;
                    return;
                }
                const { headers, data } = response;
                assignmentsHeaders = headers;
                allAssignmentsData = data;
                
                const caseNumberIndex = findHeaderIndex(headers, '#Caso');
                const interactionIdIndex = findHeaderIndex(headers, 'Interacción');
                const casosAgrupados = new Map();
                
                if (caseNumberIndex !== -1 && interactionIdIndex !== -1) {
                    allAssignmentsData.forEach(row => {
                        const caseNum = row[caseNumberIndex];
                        const interactionId = row[interactionIdIndex];
                        if (caseNum) {
                            if (!casosAgrupados.has(caseNum)) {
                                casosAgrupados.set(caseNum, new Set());
                            }
                            if(interactionId) {
                                casosAgrupados.get(caseNum).add(interactionId);
                            }
                        }
                    });
                }
                
                g_casosAResaltar = new Set();
                for (const [caseNumber, interactionSet] of casosAgrupados.entries()) {
                    if (interactionSet.size > 1) {
                        g_casosAResaltar.add(caseNumber);
                    }
                }

                populateFilterDropdowns(headers, data);
                filterAndDisplayAssignments();
                document.getElementById('advancedFiltersContainer').style.display = 'flex';
            })
            .withFailureHandler(error => {
                setRefreshButtonState(false);
                tableBody.innerHTML = `<tr><td colspan="12" class="no-data">Error al cargar: ${error.message}</td></tr>`;
            })
            .getAssignments(ldap, team);
    }
    
    function createMultiSelect(containerId, values) {
        const container = document.getElementById(containerId);
        container.innerHTML = `
            <label>${container.querySelector('label')?.innerHTML || ''}</label>
            <div class="multiselect-container">
                <div class="multiselect-display">
                    <span class="multiselect-display-text">Todos</span>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div class="multiselect-options">
                    ${values.map(val => `
                        <label>
                            <input type="checkbox" value="${val}" onchange="filterAndDisplayAssignments()">
                            ${val}
                        </label>`).join('')}
                </div>
            </div>`;
        
        const display = container.querySelector('.multiselect-display');
        const options = container.querySelector('.multiselect-options');

        display.addEventListener('click', (e) => {
            options.style.display = options.style.display === 'block' ? 'none' : 'block';
            e.stopPropagation();
        });

        document.addEventListener('click', (e) => {
            if (!container.contains(e.target)) {
                options.style.display = 'none';
            }
        });
    }

    function getMultiSelectValues(containerId) {
        const container = document.getElementById(containerId);
        if (!container) return [];
        const checkboxes = container.querySelectorAll('input[type="checkbox"]:checked');
        const values = Array.from(checkboxes).map(cb => cb.value);

        const displayText = container.querySelector('.multiselect-display-text');
        if (displayText) {
            if (values.length === 0) {
                displayText.textContent = 'Todos';
            } else if (values.length === 1) {
                displayText.textContent = values[0];
            } else {
                displayText.textContent = `${values.length} seleccionados`;
            }
        }
        return values;
    }
    
    function populateFilterDropdowns(headers, data) {
        const singleSelectMap = {
            'Sample Date': 'filterSampleDate',
            'Canal': 'filterCanal'
        };
        const multiSelectMap = {
            'Proceso': 'filterProceso',
            'Tipo de accion': 'filterTipodeaccion',
            'Oficina': 'filterOficina'
        };

        Object.keys(singleSelectMap).forEach(colName => {
            const selectId = singleSelectMap[colName];
            const select = document.getElementById(selectId);
            const colIndex = findHeaderIndex(headers, colName);
            select.removeEventListener('change', filterAndDisplayAssignments);
            
            if (colIndex !== -1) {
                const uniqueValues = [...new Set(data.map(row => row[colIndex]))].filter(Boolean).sort();
                select.innerHTML = `<option value="">Todos</option>`;
                uniqueValues.forEach(val => { select.innerHTML += `<option value="${val}">${val}</option>`; });
                select.disabled = false;
                select.addEventListener('change', filterAndDisplayAssignments);
            } else {
                select.innerHTML = `<option value="">N/A</option>`;
                select.disabled = true;
            }
        });

        Object.keys(multiSelectMap).forEach(colName => {
            const containerId = multiSelectMap[colName];
            const colIndex = findHeaderIndex(headers, colName);
            if (colIndex !== -1) {
                const uniqueValues = [...new Set(data.map(row => row[colIndex]))].filter(Boolean).sort();
                createMultiSelect(containerId, uniqueValues);
            } else {
                const container = document.getElementById(containerId);
                if (container) container.innerHTML += '<span>N/A</span>';
            }
        });
    }


    function clearAllFilters() {
        document.querySelectorAll('#advancedFiltersContainer select.filter-control').forEach(select => {
            select.value = '';
        });
        document.querySelectorAll('.multiselect-container').forEach(container => {
            container.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
            const displayText = container.querySelector('.multiselect-display-text');
            if (displayText) displayText.textContent = 'Todos';
        });
        document.getElementById('asignacionesSearchInput').value = '';
        filterAndDisplayAssignments();
    }

    function filterAndDisplayAssignments() {
        const filterValues = {
            'Sample Date': document.getElementById('filterSampleDate').value,
            'Canal': document.getElementById('filterCanal').value
        };
        const multiFilterValues = {
            'Proceso': getMultiSelectValues('filterProceso'),
            'Tipo de accion': getMultiSelectValues('filterTipodeaccion'),
            'Oficina': getMultiSelectValues('filterOficina')
        };
        const searchTerm = document.getElementById('asignacionesSearchInput').value.toLowerCase().trim();

        let filteredData = allAssignmentsData.filter(row => {
            for (const colName in filterValues) {
                const selectedValue = filterValues[colName];
                if (selectedValue) {
                    const colIndex = findHeaderIndex(assignmentsHeaders, colName);
                    if (colIndex === -1 || row[colIndex] !== selectedValue) return false;
                }
            }
            for (const colName in multiFilterValues) {
                const selectedValues = multiFilterValues[colName];
                if (selectedValues.length > 0) {
                     const colIndex = findHeaderIndex(assignmentsHeaders, colName);
                     if (colIndex === -1 || !selectedValues.includes(row[colIndex])) return false;
                }
            }
            return true;
        });

        if (searchTerm) {
            filteredData = filteredData.filter(row => {
                return row.some(cell => String(cell).toLowerCase().includes(searchTerm));
            });
        }
        
        const tableHead = document.querySelector("#dataTable thead");
        const headersToHide = ["Control Cierre Url", "Control Apertura Url", "Marca de EG", "Marca de CI", "rowIndex"];
        const visibleHeaders = assignmentsHeaders.map((h, i) => ({ name: h, index: i })).filter(h => !headersToHide.includes(h.name));
        tableHead.innerHTML = `<tr><th>#</th>${visibleHeaders.map(h => `<th>${h.name}</th>`).join('')}<th>Acciones</th></tr>`;
       
        displayAssignments(filteredData, assignmentsHeaders);
    }
    
    function displayAssignments(data, allHeaders) {
        const tableBody = document.getElementById("dataTableBody");
        const headersToHide = ["Control Cierre Url", "Control Apertura Url", "Marca de EG", "Marca de CI", "rowIndex"];
        const visibleHeaders = allHeaders.map((h, i) => ({ name: h, index: i })).filter(h => !headersToHide.includes(h.name));
        
        const visibleCaseIndex = visibleHeaders.findIndex(h => findHeaderIndex([h.name], '#Caso') !== -1);
        const visibleInteractionIndex = visibleHeaders.findIndex(h => findHeaderIndex([h.name], 'Interacción') !== -1);

        if (data.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="${visibleHeaders.length + 2}" class="no-data">No se encontraron asignaciones con los filtros aplicados.</td></tr>`;
            return;
        }

        const linkIndex = findHeaderIndex(allHeaders, "Link");
        const caseNumberIndex = findHeaderIndex(allHeaders, "#Caso");
        const interactionIdIndex = findHeaderIndex(allHeaders, "Interacción");
        const sampleDateIndex = findHeaderIndex(allHeaders, "Sample Date");
        const fechaAsignacionIndex = findHeaderIndex(allHeaders, "Fecha y hora de la asignación");
        const rowIndexIndex = findHeaderIndex(allHeaders, "rowIndex");
        const aperturaTimestampIndex = findHeaderIndex(allHeaders, "Control Apertura Url");
        const ldap = document.getElementById("ldapSelect").value;
        const team = document.getElementById("teamSelect").value;
        
        const tableHtml = data.map((row, index) => {
            const caseNumber = row[caseNumberIndex] || '';
            const interactionId = row[interactionIdIndex] || '';
            const rowIndex = row[rowIndexIndex] || '';
            const aperturaTimestamp = row[aperturaTimestampIndex] || '';
            const rowId = `row-${caseNumber}-${interactionId}-${rowIndex}`.replace(/[^a-zA-Z0-9-_]/g, '');

            const sampleDayDate = parseDateString(row[sampleDateIndex]);
            const fechaAsignacionDate = parseDateString(row[fechaAsignacionIndex]);
            const isOverdue = sampleDayDate && fechaAsignacionDate && sampleDayDate.getTime() < fechaAsignacionDate.getTime();
            const debeResaltar = caseNumber && g_casosAResaltar.has(caseNumber);

            let rowHtml = `<tr id="${rowId}" class="${isOverdue ? 'overdue-case' : ''}"><td>${index + 1}</td>`;
            visibleHeaders.forEach((header, visibleHeaderIdx) => {
                let cellContent = row[header.index] || '';
                let tdClass = '';
                 if (debeResaltar && (visibleHeaderIdx === visibleCaseIndex || visibleHeaderIdx === visibleInteractionIndex)) {
                     tdClass = 'repeated-case-highlight';
                 }
                if(header.index === linkIndex && cellContent.startsWith('http')) {
                    const safeUrl = cellContent.replace(/"/g, '&quot;');
                    let linkInnerHtml = `<a href="${safeUrl}" target="_blank" title="Abrir Enlace" onclick="logLinkClick(event, '${team}', '${ldap}', '${caseNumber}', '${interactionId}')">Enlace</a>`;
                    if (aperturaTimestamp) {
                        const safeTimestamp = String(aperturaTimestamp).replace(/"/g, '&quot;');
                        linkInnerHtml = `<a href="${safeUrl}" target="_blank" title="Abrir Enlace" onclick="logLinkClick(event, '${team}', '${ldap}', '${caseNumber}', '${interactionId}')">Enlace<i class="fas fa-eye" title="Abierto: ${safeTimestamp}" style="color:green;margin-left:5px;"></i></a>`;
                    }
                    cellContent = linkInnerHtml;
                }
                rowHtml += `<td class="${tdClass}">${cellContent}</td>`;
            });
            
            const params = `'${rowId}', '${team}', '${ldap}', '${caseNumber}', '${interactionId}', '${rowIndex}'`;
            rowHtml += `<td class="actions-cell"><button class="btn-action-unified" onclick="iniciarProcesoFinalizacion(${params})"><i class="fas fa-check-double icon"></i>Finalizar Gestión</button></td>`;
            rowHtml += `</tr>`;
            return rowHtml;
        }).join('');
        tableBody.innerHTML = tableHtml;
    }
    
    function getCurrentFormattedTimestampCliente() {
        const now = new Date();
        const day = String(now.getDate()).padStart(2, '0');
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const year = now.getFullYear();
        let hours = now.getHours();
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const seconds = String(now.getSeconds()).padStart(2, '0');
        const ampm = hours >= 12 ? 'PM' : 'AM';
        hours = hours % 12;
        hours = hours ? hours : 12;
        const hoursStr = String(hours).padStart(2, '0');
        return `${day}-${month}-${year}, ${hoursStr}:${minutes}:${seconds} ${ampm}`;
    }

    function logLinkClick(event, team, ldap, caseNumber, interactionId) {
        const link = event.currentTarget;
        const hasExistingIcon = link.querySelector('.fa-eye, .fa-exclamation-triangle');
        
        if (hasExistingIcon) return; 

        if (!link.querySelector('.fa-spinner')) {
            const spinner = document.createElement('i');
            spinner.className = 'fas fa-spinner fa-spin';
            spinner.style.marginLeft = '5px';
            link.appendChild(spinner);
        }

        google.script.run
            .withSuccessHandler(msg => {
                const spinner = link.querySelector('.fa-spinner');
                if (spinner) spinner.remove();

                if (!link.querySelector('.fa-eye') && !link.querySelector('.fa-exclamation-triangle')) {
                    const icon = document.createElement('i');
                    icon.className = 'fas fa-eye';
                    icon.style.color = 'green';
                    icon.style.marginLeft = '5px';
                    icon.title = `Abierto: ${getCurrentFormattedTimestampCliente()}`;
                    link.appendChild(icon);
                }
            })
            .withFailureHandler(err => {
                const spinner = link.querySelector('.fa-spinner');
                if (spinner) spinner.remove();
                
                if (!link.querySelector('.fa-exclamation-triangle')) {
                    const icon = document.createElement('i');
                    icon.className = 'fas fa-exclamation-triangle';
                    icon.style.color = 'red';
                    icon.style.marginLeft = '5px';
                    icon.title = `Error al registrar: ${err.message}`;
                    link.appendChild(icon);
                }
            })
            .recordTimestamp(team, ldap, caseNumber, interactionId, 'apertura');
    }

    function iniciarProcesoFinalizacion(rowId, team, ldap, caseNumber, interactionId, rowIndex) {
        const htmlContent = `
           <p style="text-align: center; margin-bottom: 20px;">Marque todas las opciones que apliquen para finalizar el caso.</p>
            <h4 class="swal-gestion-subtitle">Matriz de Faltas - Error de Gestión:</h4>
            <ul class="swal-gestion-list">
                <li><input type="checkbox" id="eg-CasoNA" value="Caso N/A"><label for="eg-CasoNA">Caso N/A - Cerrado como "No auditable"</label></li>
                <li><input type="checkbox" id="eg-EG1" value="EG1"><label for="eg-EG1">EG1 - Gestión incorrecta - no hecha</label></li>
                <li><input type="checkbox" id="eg-EG2" value="EG2"><label for="eg-EG2">EG2 - Respuesta Incorrecta - Incompleta</label></li>
                <li><input type="checkbox" id="eg-EG3" value="EG3"><label for="eg-EG3">EG3 - Ampliación de consulta o pedido de datos incorrecto</label></li>
                <li><input type="checkbox" id="eg-EG4" value="EG4"><label for="eg-EG4">EG4 - Clasificación de proceso incorrecto</label></li>
                <li><input type="checkbox" id="eg-EG5" value="EG5"><label for="eg-EG5">EG5 - [SHS] Desvíos Regulatorios y de Plazos</label></li>
                <li><input type="checkbox" id="eg-CerradoNASOEG" value="Cerrado N/A-SO-EG"><label for="eg-CerradoNASOEG">Cerrado N/A-SO-EG</label></li>
            </ul>
            <h4 class="swal-gestion-subtitle">Matriz de Faltas - Conducta Inadecuada:</h4>
            <ul class="swal-gestion-list">
                <li><input type="checkbox" id="ci-CasoNACI" value="Caso N/A-CI"><label for="ci-CasoNACI">Caso N/A-CI - Cerrado como "No auditable"</label></li>
                <li><input type="checkbox" id="ci-CI1" value="CI1"><label for="ci-CI1">CI1 - Genera promesa o expectativa indebida</label></li>
                <li><input type="checkbox" id="ci-CI2" value="CI2"><label for="ci-CI2">CI2 - CSR cuando no corresponde</label></li>
                <li><input type="checkbox" id="ci-CI3" value="CI3"><label for="ci-CI3">CI3 - Derivación incorrecta</label></li>
                <li><input type="checkbox" id="ci-CI4" value="CI4"><label for="ci-CI4">CI4 - Habla mal de MeLi</label></li>
                <li><input type="checkbox" id="ci-CI5" value="CI5"><label for="ci-CI5">CI5 - Infracción legal</label></li>
                <li><input type="checkbox" id="ci-CI6" value="CI6"><label for="ci-CI6">CI6 - Bonificación incorrecta</label></li>
                <li><input type="checkbox" id="ci-CI7" value="CI7"><label for="ci-CI7">CI7 - Particularidades</label></li>
                
                <li><input type="checkbox" id="ci-CasoSOCI" value="Caso SO - Cerrado N/A-SO-CI"><label for="ci-CasoSOCI">Caso SO - Cerrado N/A-SO-CI</label></li>
                <li class="ci-tl-item-container">
                  <input type="checkbox" id="ci-tl-si" value="Si"><label for="ci-tl-si">Sí</label>
                  <input type="checkbox" id="ci-tl-no" value="No"><label for="ci-tl-no">No</label>
                  <span>CI – TL – ¿La Conducta Inadecuada tiene un Visto con TL?</span>
                </li>
            </ul>`;


        Swal.fire({
            title: `Finalizar Caso #${caseNumber}`,
            html: htmlContent,
            showCancelButton: true,
            confirmButtonText: '<i class="fas fa-check-double icon"></i> Finalizar',
            cancelButtonText: '<i class="fas fa-times icon"></i> Cancelar',
            confirmButtonColor: '#28a745',
            width: '750px',
            didOpen: () => {
                const si = document.getElementById('ci-tl-si');
                const no = document.getElementById('ci-tl-no');
                si.addEventListener('change', () => { if (si.checked) no.checked = false; });
                no.addEventListener('change', () => { if (no.checked) si.checked = false; });
            },
            preConfirm: () => {
                const marcasEG = Array.from(document.querySelectorAll('input[id^="eg-"]:checked')).map(cb => cb.value);
                const marcasCI = Array.from(document.querySelectorAll('input[id^="ci-"]:checked')).map(cb => cb.value);
                const tlSi = document.getElementById('ci-tl-si').checked;
                const tlNo = document.getElementById('ci-tl-no').checked;

                if (marcasEG.length === 0) {
                    Swal.showValidationMessage('Debe seleccionar al menos una opción en "Error de Gestión".');
                    return false;
                }
                if (marcasCI.length === 0) {
                    Swal.showValidationMessage('Debe seleccionar al menos una opción en "Conducta Inadecuada".');
                    return false;
                }
                if (!tlSi && !tlNo) {
                    Swal.showValidationMessage('Debe responder "Sí" o "No" a la pregunta sobre el Visto con TL.');
                    return false;
                }
                
                marcasCI.push(`Visto TL: ${tlSi ? 'Sí' : 'No'}`);
                return { marcasEG, marcasCI };
            }
        }).then((result) => {
            if (result.isConfirmed) {
                const { marcasEG, marcasCI } = result.value;
                const rowElement = document.getElementById(rowId);
                const button = rowElement?.querySelector('button');
                if(button) setButtonLoadingState(button, true, null, 'Finalizando...');
                
                if(rowElement) {
                    rowElement.style.transition = 'opacity 0.4s ease-out';
                    rowElement.style.opacity = '0';
                    setTimeout(() => {
                        allAssignmentsData = allAssignmentsData.filter(row => row[findHeaderIndex(assignmentsHeaders, 'rowIndex')] !== parseInt(rowIndex, 10));
                        filterAndDisplayAssignments();
                    }, 400);
                }

                const params = { team, ldap, caseNumber, interactionId, marcasEG, marcasCI, rowIndex };
                google.script.run
                    .withSuccessHandler(msg => {
                        Swal.fire({ icon: 'success', title: '¡Éxito!', text: msg, toast: true, position: 'top-end', showConfirmButton: false, timer: 3000 });
                    })
                    .withFailureHandler(error => {
                        Swal.fire('Error', `No se pudo finalizar: ${error.message}. La tabla se recargará para asegurar la consistencia.`, 'error')
                        .then(() => handleAssignmentSelectionChange());
                    })
                    .finalizarYMarcarGestion(params);
            }
        });
    }

    // --- Lógica Pestaña Seguimiento QA ---
    function guardarRegistroQA() {
      if (!currentUser) return;
      const ldapQa = document.getElementById("qaLdapQa").value.trim();
      const team = document.getElementById("qaTeam").value.trim();
      const proceso = document.getElementById("qaProceso").value.trim();
      const caso = document.getElementById("qaCaso").value.trim();
      const rep = document.getElementById("qaRepEvaluar").value.trim();
      const pregunta = document.getElementById("qaPregunta").value.trim();

      if (!team || !proceso || !caso || !rep || !pregunta) {
        Swal.fire('Campos Incompletos', 'Por favor, complete todos los campos del formulario QA.', 'warning');
        return;
      }
      const data = [null, ldapQa, team, proceso, caso, rep, pregunta];

      const saveButton = document.getElementById('saveQaRecordButton');
      setButtonLoadingState(saveButton, true, null, "Guardando...");

      google.script.run
        .withSuccessHandler(message => {
          setButtonLoadingState(saveButton, false, '<i class="fas fa-save icon"></i>Guardar Nuevo Registro');
          Swal.fire('Registro Guardado', message, 'success');
          limpiarFormularioQA();
          document.getElementById('qaFormContainer').style.display = 'none';
          cargarRegistrosDesdeSheetsQA();
        })
        .withFailureHandler(error => {
          setButtonLoadingState(saveButton, false, '<i class="fas fa-save icon"></i>Guardar Nuevo Registro');
          Swal.fire('Error al Guardar', `No se pudo guardar: ${error.message}`, 'error');
        })
        .guardarEnSheetsQA(data);
    }

    function limpiarFormularioQA() {
      document.getElementById("qaForm").reset();
      if (currentUser) { document.getElementById('qaLdapQa').value = currentUser.username; }
    }

    function cargarRegistrosDesdeSheetsQA() {
      const body = document.getElementById("qaTableBody");
      if (!body || !currentUser) return;

      body.innerHTML = `<tr><td colspan="14" class="no-data"><i class="fas fa-spinner fa-spin"></i>Cargando registros...</td></tr>`;
      document.getElementById("qaPaginationControls").innerHTML = '';
      const searchInput = document.getElementById('qaSearchInput');
      if (searchInput) {
        searchInput.value = '';
      } else {
        console.log('Elemento null: qaSearchInput');
      }
      const estadoFilter = document.getElementById('qaEstadoFilter');
      if (estadoFilter) {
        estadoFilter.value = '';
      } else {
        console.log('Elemento null: qaEstadoFilter');
      }
      const fechaRegistroFilter = document.getElementById('qaFechaRegistroFilter');
      if (fechaRegistroFilter) {
        fechaRegistroFilter.value = '';
      } else {
        console.log('Elemento null: qaFechaRegistroFilter');
      }
      setRefreshButtonState(true);

      google.script.run
        .withSuccessHandler(data => {
          setRefreshButtonState(false);
          if (!data || !Array.isArray(data) || data.length <= 1) {
            body.innerHTML = `<tr><td colspan="14" class="no-data">No hay registros QA para mostrar.</td></tr>`;
            currentQaData = [];
            currentFilteredQaData = [];
            actualizarFiltroFechaRegistro();
          } else {
            currentQaData = data.slice(1);
            currentFilteredQaData = [...currentQaData];
            qaCurrentPage = 1;
            displayQaPage(currentFilteredQaData);
            actualizarFiltroFechaRegistro();
          }
        })
        .withFailureHandler(e => {
          setRefreshButtonState(false);
          body.innerHTML = `<tr><td colspan="14" class="no-data">Error al cargar registros: ${e.message}</td></tr>`;
        })
        .obtenerRegistrosQA(currentUser);
    }

    function filterAndDisplayQaData(term) {
      // Obtener el término de búsqueda del input si no se proporciona
      if (term === undefined) {
        term = document.getElementById('qaSearchInput')?.value || '';
      }
      
      // Obtener el filtro de estado
      const estadoFilter = document.getElementById('qaEstadoFilter')?.value || '';
      
      term = term.toLowerCase().trim();
      
      currentFilteredQaData = currentQaData.filter(row => {
        // Filtro por término de búsqueda (fecha, LDAP QA, interacción)
        const matchesSearch = !term || 
          (row[0] || '').toLowerCase().includes(term) || 
          (row[1] || '').toLowerCase().includes(term) || 
          (row[4] || '').toLowerCase().includes(term);
        
        // Filtro por estado (columna 7)
        const matchesEstado = !estadoFilter || (row[7] || '') === estadoFilter;
        
        return matchesSearch && matchesEstado;
      });
      
      qaCurrentPage = 1;
      displayQaPage(currentFilteredQaData);
    }

    function displayQaPage(data) {
        const body = document.getElementById("qaTableBody");
        const searchTerm = document.getElementById('qaSearchInput')?.value.trim() || '';
        
        if (!data || data.length === 0) {
            const searchTerm = document.getElementById('qaSearchInput')?.value.trim() || '';
            const estadoFilter = document.getElementById('qaEstadoFilter')?.value || '';
            
            let msg = "No hay registros QA disponibles.";
            if (searchTerm && estadoFilter) {
                msg = `No se encontraron registros para "${searchTerm}" con estado "${estadoFilter}".`;
            } else if (searchTerm) {
                msg = `No se encontraron registros para "${searchTerm}".`;
            } else if (estadoFilter) {
                msg = `No se encontraron registros con estado "${estadoFilter}".`;
            }
            
            body.innerHTML = `<tr><td colspan="14" class="no-data">${msg}</td></tr>`;
            renderQaPaginationControls(0);
            return;
        }

        const startIndex = (qaCurrentPage - 1) * itemsPerPageQA;
        const pageData = data.slice(startIndex, startIndex + itemsPerPageQA);

        body.innerHTML = pageData.map(row => {
            let htmlRow = '<tr>';
            for (let i = 0; i < 13; i++) {
                htmlRow += `<td class="${(i === 11 || i === 12) ? 'text-center' : ''}">${row[i] != null ? row[i] : ''}</td>`;
            }
            const escapedRowData = JSON.stringify(row).replace(/'/g, "&apos;").replace(/"/g, "&quot;");
            htmlRow += `<td class="qa-actions-col">
                          <button class="btn-edit" data-row-data='${escapedRowData}' onclick="abrirPopupEdicionQA(this)">
                            <i class="fas fa-edit icon"></i>Editar
                          </button>
                        </td>`;
            return htmlRow + '</tr>';
        }).join('');

        renderQaPaginationControls(data.length);
    }

    function renderQaPaginationControls(totalItems) {
        const controls = document.getElementById("qaPaginationControls");
        if (!controls) return;
        
        const totalPages = Math.ceil(totalItems / itemsPerPageQA);
        if (totalPages <= 1) {
            controls.innerHTML = totalItems > 0 ? `<span class="pagination-info">Mostrando ${totalItems} de ${totalItems}</span>` : '';
            return;
        }

        let html = `<button onclick="changeQaPage(${qaCurrentPage - 1})" ${qaCurrentPage === 1 ? 'disabled' : ''}><i class="fas fa-chevron-left"></i></button>`;
        for (let i = 1; i <= totalPages; i++) {
            html += `<button onclick="changeQaPage(${i})" class="${i === qaCurrentPage ? 'active' : ''}">${i}</button>`;
        }
        html += `<button onclick="changeQaPage(${qaCurrentPage + 1})" ${qaCurrentPage === totalPages ? 'disabled' : ''}><i class="fas fa-chevron-right"></i></button>`;
        const startItem = (qaCurrentPage - 1) * itemsPerPageQA + 1;
        const endItem = Math.min(startItem + itemsPerPageQA - 1, totalItems);
        html += `<span class="pagination-info">Mostrando ${startItem}-${endItem} de ${totalItems}</span>`;
        controls.innerHTML = html;
    }

    function changeQaPage(page) {
        const totalPages = Math.ceil(currentFilteredQaData.length / itemsPerPageQA);
        if (page >= 1 && page <= totalPages) {
            qaCurrentPage = page;
            displayQaPage(currentFilteredQaData);
            document.querySelector('#qa .table-container')?.scrollIntoView({ behavior: 'smooth' });
        }
    }

    function clearQaFilters() {
        const searchInput2 = document.getElementById('qaSearchInput');
        if (searchInput2) {
            searchInput2.value = '';
        } else {
            console.log('Elemento null: qaSearchInput (clearQaFilters)');
        }
        const estadoFilter2 = document.getElementById('qaEstadoFilter');
        if (estadoFilter2) {
            estadoFilter2.value = '';
        } else {
            console.log('Elemento null: qaEstadoFilter (clearQaFilters)');
        }
        const fechaRegistroFilter2 = document.getElementById('qaFechaRegistroFilter');
        if (fechaRegistroFilter2) {
            fechaRegistroFilter2.value = '';
        } else {
            console.log('Elemento null: qaFechaRegistroFilter (clearQaFilters)');
        }
        filterAndDisplayQaData();
    }

    function abrirPopupEdicionQA(buttonElement) {
        const rowDataString = buttonElement.getAttribute('data-row-data').replace(/&apos;/g,"'").replace(/"/g,'"');
        const rowData = JSON.parse(rowDataString);
        
        const [registroId, ldapQaQueRegistro, , , casoNumero, , , estado, , respuesta, respuestaQS, vistoFormacion, vistoMeli, complejidad, comentarioAdicional] = rowData;

        const isAdmin = currentUser.rol === 'Administrador';
        const isQs = currentUser.rol === 'QS';
        const respuestaAdminDisabled = isQs ? 'disabled' : '';
        const respuestaQsDisabled = ''; // <-- CAMBIO REALIZADO AQUÍ

        const formHtml = `<div style="text-align:left;"><p><strong>ID (Fecha Registro):</strong> ${registroId}</p><p><strong>Interacción:</strong> ${casoNumero} / <strong>Registró QA:</strong> ${ldapQaQueRegistro}</p><hr>
            <label class="swal-label" for="swal-estado">Estado:</label><select id="swal-estado" class="swal-select"><option value="Pendiente de revisión" ${estado === 'Pendiente de revisión' ? 'selected' : ''}>Pendiente de revisión</option><option value="Revisado Formación" ${estado === 'Revisado Formación' ? 'selected' : ''}>Revisado Formación</option><option value="Revisado QS" ${estado === 'Revisado QS' ? 'selected' : ''}>Revisado QS</option></select>
            <label class="swal-label" for="swal-respuesta">Respuesta (Admin):</label><textarea id="swal-respuesta" class="swal-input" rows="3" ${respuestaAdminDisabled}>${respuesta || ''}</textarea>
            <label class="swal-label" for="swal-respuesta-qs">Respuesta QS:</label><textarea id="swal-respuesta-qs" class="swal-input" rows="3" ${respuestaQsDisabled}>${respuestaQS || ''}</textarea>
            <label class="swal-label" for="swal-comentario-adicional">Comentario adicional:</label><textarea id="swal-comentario-adicional" class="swal-input" rows="2">${comentarioAdicional || ''}</textarea>
            <div class="swal-qa-grid">
              <div><label class="swal-label" for="swal-formacion">Visto Formación:</label><select id="swal-formacion" class="swal-select" ${respuestaAdminDisabled}><option value="" ${!vistoFormacion ?'selected':''}>Seleccionar...</option><option value="Sí" ${vistoFormacion==='Sí'?'selected':''}>Sí</option><option value="No" ${vistoFormacion==='No'?'selected':''}>No</option></select></div>
              <div><label class="swal-label" for="swal-meli">Visto Meli:</label><select id="swal-meli" class="swal-select" ${respuestaAdminDisabled}><option value="" ${!vistoMeli?'selected':''}>Seleccionar...</option><option value="Sí" ${vistoMeli==='Sí'?'selected':''}>Sí</option><option value="No" ${vistoMeli==='No'?'selected':''}>No</option></select></div>
            </div>
            <div class="swal-qa-grid">
              <div><label class="swal-label" for="swal-complejidad">Complejidad:</label><select id="swal-complejidad" class="swal-select" ${respuestaAdminDisabled}><option value="" ${!complejidad?'selected':''}>Seleccionar...</option><option value="Alta" ${complejidad==='Alta'?'selected':''}>Alta</option><option value="Media" ${complejidad==='Media'?'selected':''}>Media</option><option value="Baja" ${complejidad==='Baja'?'selected':''}>Baja</option></select></div>
            </div></div>`;

        Swal.fire({
            title: `Editar Registro QA #${casoNumero}`, html: formHtml, confirmButtonText: '<i class="fas fa-save icon"></i> Guardar',
            cancelButtonText: '<i class="fas fa-times icon"></i> Cancelar', showCancelButton: true, width: '700px',
            preConfirm: () => ({
                nuevoEstado: document.getElementById('swal-estado').value,
                nuevaRespuesta: document.getElementById('swal-respuesta').value,
                respuestaQS: document.getElementById('swal-respuesta-qs').value,
                comentarioAdicional: document.getElementById('swal-comentario-adicional').value,
                vistoFormacion: document.getElementById('swal-formacion').value,
                vistoMeli: document.getElementById('swal-meli').value,
                complejidad: document.getElementById('swal-complejidad').value
            })
        }).then(result => {
            if (result.isConfirmed) {
                const { nuevoEstado, nuevaRespuesta, respuestaQS, comentarioAdicional, vistoFormacion, vistoMeli, complejidad } = result.value;
                Swal.showLoading();
                google.script.run
                    .withSuccessHandler(msg => { 
                      Swal.fire('¡Actualizado!', msg, 'success'); 
                      cargarRegistrosDesdeSheetsQA(); 
                    })
                    .withFailureHandler(err => { Swal.fire('Error', `No se pudo guardar: ${err.message}`, 'error'); })
                    .actualizarRegistroQA(registroId, nuevoEstado, nuevaRespuesta, vistoFormacion, vistoMeli, casoNumero, respuestaQS, ldapQaQueRegistro, currentUser, complejidad, comentarioAdicional);
            }
        });
    }

    function checkForNotifications() {
        if (!currentUser || document.querySelector('.swal2-container')) return;
        google.script.run
            .withSuccessHandler(notifications => {
                if (notifications && notifications.length > 0) {
                    const notificationHtml = '<ul style="text-align: left; margin-left: 20px;">' + notifications.map(n => `<li>${n}</li>`).join('') + '</ul>';
                    Swal.fire({
                        title: '<strong>Tienes una respuesta en Seguimiento QA</strong>',
                        icon: 'info',
                        html: notificationHtml,
                        showCloseButton: true,
                        focusConfirm: false,
                        confirmButtonText: '<i class="fa fa-thumbs-up"></i> Entendido',
                        confirmButtonAriaLabel: 'Entendido',
                    });
                }
            })
            .withFailureHandler(err => {
                console.error("Error checking for notifications:", err.message);
            })
            .checkForNotifications(currentUser);
    }

    // --- Filtro de Fecha de Registro ---
    function actualizarFiltroFechaRegistro() {
        const select = document.getElementById('qaFechaRegistroFilter');
        if (!select) return;
        // Obtener solo la parte de la fecha (antes de la coma o espacio)
        const fechas = Array.from(new Set(currentQaData.map(row => {
            const raw = row[0] || '';
            return raw.split(',')[0].trim();
        }))).filter(Boolean).sort();
        select.innerHTML = '<option value="">Todas las fechas</option>' + fechas.map(f => `<option value="${f}">${f}</option>`).join('');
    }

    // Al cambiar el filtro de fecha, filtrar la tabla
    if (document.getElementById('qaFechaRegistroFilter')) {
        document.getElementById('qaFechaRegistroFilter').addEventListener('change', function() {
            filtrarPorFechaRegistro();
        });
    }

    function filtrarPorFechaRegistro() {
        const fecha = document.getElementById('qaFechaRegistroFilter').value;
        let dataFiltrada = fecha ? currentQaData.filter(row => {
            const raw = row[0] || '';
            const soloFecha = raw.split(',')[0].trim();
            return soloFecha === fecha;
        }) : [...currentQaData];
        // Aplicar también el filtro de estado si está activo
        const estado = document.getElementById('qaEstadoFilter')?.value || '';
        if (estado) {
            dataFiltrada = dataFiltrada.filter(row => (row[7] || '') === estado);
        }
        // Aplicar también el filtro de búsqueda si está activo
        const term = document.getElementById('qaSearchInput')?.value.toLowerCase().trim() || '';
        if (term) {
            dataFiltrada = dataFiltrada.filter(row =>
                (row[0] || '').toLowerCase().includes(term) ||
                (row[1] || '').toLowerCase().includes(term) ||
                (row[4] || '').toLowerCase().includes(term)
            );
        }
        qaCurrentPage = 1;
        displayQaPage(dataFiltrada);
    }
  </script>
</body>
</html>
